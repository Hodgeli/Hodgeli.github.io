<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>我的追寻</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="进一寸有一寸的欢喜">
<meta property="og:type" content="website">
<meta property="og:title" content="我的追寻">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="我的追寻">
<meta property="og:description" content="进一寸有一寸的欢喜">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="我的追寻">
<meta name="twitter:description" content="进一寸有一寸的欢喜">
  
    <link rel="alternate" href="/atom.xml" title="我的追寻" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">我的追寻</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">进一寸有一寸的欢喜</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-CNN" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/30/CNN/" class="article-date">
  <time datetime="2018-01-30T07:15:23.000Z" itemprop="datePublished">2018-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PyTorch笔记/">PyTorch笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/30/CNN/">CNN</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><p>利用卷积神经网络实现对mnist手写数字图片的识别<br>其中用到了批训练方法</p>
<h6 id="CNN-py"><a href="#CNN-py" class="headerlink" title="CNN.py"></a>CNN.py</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># third-party library</span></span><br><span class="line"><span class="built_in">import</span> torch</span><br><span class="line"><span class="built_in">import</span> torch.nn as nn</span><br><span class="line">from torch.autograd <span class="built_in">import</span> Variable</span><br><span class="line"><span class="built_in">import</span> torch.utils.data as Data</span><br><span class="line"><span class="built_in">import</span> torchvision</span><br><span class="line"></span><br><span class="line"><span class="comment"># torch.manual_seed(1)    # reproducible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hyper Parameters</span></span><br><span class="line"><span class="attr">EPOCH</span> = <span class="number">1</span>               <span class="comment"># train the training data n times, to save time, we just train 1 epoch</span></span><br><span class="line"><span class="attr">BATCH_SIZE</span> = <span class="number">50</span></span><br><span class="line"><span class="attr">LR</span> = <span class="number">0.001</span>              <span class="comment"># learning rate</span></span><br><span class="line"><span class="attr">DOWNLOAD_MNIST</span> = False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Mnist digits dataset</span></span><br><span class="line"><span class="keyword">if</span> not(os.path.exists('./mnist/')) <span class="literal">or</span> not os.listdir('./mnist/'):</span><br><span class="line">    <span class="comment"># not mnist dir or mnist is empyt dir</span></span><br><span class="line">    <span class="attr">DOWNLOAD_MNIST</span> = True</span><br><span class="line"></span><br><span class="line"><span class="attr">train_data</span> = torchvision.datasets.MNIST(</span><br><span class="line">    <span class="attr">root='./mnist/',</span></span><br><span class="line">    <span class="attr">train=True,</span>                                     <span class="comment"># this is training data</span></span><br><span class="line">    <span class="attr">transform=torchvision.transforms.ToTensor(),</span>    <span class="comment"># Converts a PIL.Image or numpy.ndarray to</span></span><br><span class="line">                                                    <span class="comment"># torch.FloatTensor of shape (C x H x W) and normalize in the range [0.0, 1.0]</span></span><br><span class="line">    <span class="attr">download=DOWNLOAD_MNIST,</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Data Loader for easy mini-batch return in training, the image batch shape will be (50, 1, 28, 28)</span></span><br><span class="line"><span class="attr">train_loader</span> = Data.DataLoader(<span class="attr">dataset=train_data,</span> <span class="attr">batch_size=BATCH_SIZE,</span> <span class="attr">shuffle=True)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># convert test data into Variable, pick 2000 samples to speed up testing</span></span><br><span class="line"><span class="attr">test_data</span> = torchvision.datasets.MNIST(<span class="attr">root='./mnist/',</span> <span class="attr">train=False)</span></span><br><span class="line"><span class="attr">test_x</span> = Variable(torch.unsqueeze(test_data.test_data, <span class="attr">dim=1),</span> <span class="attr">volatile=True).type(torch.FloatTensor)[:2000]/255.</span>   <span class="comment"># shape from (2000, 28, 28) to (2000, 1, 28, 28), value in range(0,1)</span></span><br><span class="line"><span class="attr">test_y</span> = test_data.test_labels[:<span class="number">2000</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CNN(nn.Module):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        super(CNN, self).__init__()</span><br><span class="line">        self.<span class="attr">conv1</span> = nn.Sequential(         <span class="comment"># input shape (1, 28, 28)</span></span><br><span class="line">            nn.Conv2d(</span><br><span class="line">                <span class="attr">in_channels=1,</span>              <span class="comment"># input height</span></span><br><span class="line">                <span class="attr">out_channels=16,</span>            <span class="comment"># n_filters</span></span><br><span class="line">                <span class="attr">kernel_size=5,</span>              <span class="comment"># filter size</span></span><br><span class="line">                <span class="attr">stride=1,</span>                   <span class="comment"># filter movement/step</span></span><br><span class="line">                <span class="attr">padding=2,</span>                  <span class="comment"># if want same width and length of this image after con2d, padding=(kernel_size-1)/2 if stride=1</span></span><br><span class="line">            ),                              <span class="comment"># output shape (16, 28, 28)</span></span><br><span class="line">            nn.ReLU(),                      <span class="comment"># activation</span></span><br><span class="line">            nn.MaxPool2d(<span class="attr">kernel_size=2),</span>    <span class="comment"># choose max value in 2x2 area, output shape (16, 14, 14)</span></span><br><span class="line">        )</span><br><span class="line">        self.<span class="attr">conv2</span> = nn.Sequential(         <span class="comment"># input shape (1, 14, 14)</span></span><br><span class="line">            nn.Conv2d(<span class="number">16</span>, <span class="number">32</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">2</span>),     <span class="comment"># output shape (32, 14, 14)</span></span><br><span class="line">            nn.ReLU(),                      <span class="comment"># activation</span></span><br><span class="line">            nn.MaxPool2d(<span class="number">2</span>),                <span class="comment"># output shape (32, 7, 7)</span></span><br><span class="line">        )</span><br><span class="line">        self.<span class="attr">out</span> = nn.Linear(<span class="number">32</span> * <span class="number">7</span> * <span class="number">7</span>, <span class="number">10</span>)   <span class="comment"># fully connected layer, output 10 classes</span></span><br><span class="line"></span><br><span class="line">    def forward(self, x):</span><br><span class="line">        <span class="attr">x</span> = self.conv1(x)</span><br><span class="line">        <span class="attr">x</span> = self.conv2(x)</span><br><span class="line">        <span class="attr">x</span> = x.view(x.size(<span class="number">0</span>), -<span class="number">1</span>)           <span class="comment"># flatten the output of conv2 to (batch_size, 32 * 7 * 7)</span></span><br><span class="line">        <span class="attr">output</span> = self.out(x)</span><br><span class="line">        return output, x    <span class="comment"># return x for visualization</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">cnn</span> = CNN()</span><br><span class="line"></span><br><span class="line"><span class="attr">optimizer</span> = torch.optim.Adam(cnn.parameters(), <span class="attr">lr=LR)</span>   <span class="comment"># optimize all cnn parameters</span></span><br><span class="line"><span class="attr">loss_func</span> = nn.CrossEntropyLoss()                       <span class="comment"># the target label is not one-hotted</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># training and testing</span></span><br><span class="line">for epoch <span class="keyword">in</span> range(EPOCH):</span><br><span class="line">    for step, (x, y) <span class="keyword">in</span> enumerate(train_loader):   <span class="comment"># gives batch data, normalize x when iterate train_loader</span></span><br><span class="line">        <span class="attr">b_x</span> = Variable(x)   <span class="comment"># batch x</span></span><br><span class="line">        <span class="attr">b_y</span> = Variable(y)   <span class="comment"># batch y</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">output</span> = cnn(b_x)[<span class="number">0</span>]               <span class="comment"># cnn output</span></span><br><span class="line">        <span class="attr">loss</span> = loss_func(output, b_y)   <span class="comment"># cross entropy loss</span></span><br><span class="line">        optimizer.zero_grad()           <span class="comment"># clear gradients for this training step</span></span><br><span class="line">        loss.backward()                 <span class="comment"># backpropagation, compute gradients</span></span><br><span class="line">        optimizer.step()                <span class="comment"># apply gradients</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> step % <span class="number">50</span> == <span class="number">0</span>:</span><br><span class="line">            test_output, <span class="attr">last_layer</span> = cnn(test_x)</span><br><span class="line">            <span class="attr">pred_y</span> = torch.max(test_output, <span class="number">1</span>)[<span class="number">1</span>].data.squeeze()</span><br><span class="line">            <span class="attr">accuracy</span> = sum(<span class="attr">pred_y</span> == test_y) / float(test_y.size(<span class="number">0</span>))</span><br><span class="line">            print('Epoch: ', epoch, '| train loss: %.<span class="number">4</span>f' % loss.data[<span class="number">0</span>], '| test accuracy: %.<span class="number">2</span>f' % accuracy)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print 10 predictions from test data</span></span><br><span class="line">test_output, <span class="attr">_</span> = cnn(test_x[:<span class="number">10</span>])</span><br><span class="line"><span class="attr">pred_y</span> = torch.max(test_output, <span class="number">1</span>)[<span class="number">1</span>].data.numpy().squeeze()</span><br><span class="line">print(pred_y, 'prediction number')</span><br><span class="line">print(test_y[:<span class="number">10</span>].numpy(), 'real number')</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/30/CNN/" data-id="cl8vfrwpa0000ogc5pa4vid70" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pytorch/">pytorch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/神经网络/">神经网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hashtag-microblog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/26/hashtag-microblog/" class="article-date">
  <time datetime="2018-01-26T09:03:36.000Z" itemprop="datePublished">2018-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/读论文/">读论文</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/26/hashtag-microblog/">Hashtag Recommendation for Multimodal Microblog Using Co-Attention Network</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h5><p>以往：根据微博文本信息推荐Hashtag<br>本文：多模态信息同时考虑+Attention机制</p>
<h5 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h5><p>以往：只使用文字有时无法准确定位微博的中心主题；部分研究简单地将文字和图片特征加以整合，<br>而事实上正确的hashtag只与文本和图象的部分内容相关联。<br>现在：加入Attention机制，文本、图像相互影响并指导对方特征的提取。一个兼顾文本和图像相互影响的共同关注网络。<br>之前的研究没有考虑图像对文本特征提取的指导意义。注意机制允许模型专注于视觉或文本输入的特定部分，并已成功用于各种多模式模型。在这项工作中，我们采用了从输入推文和图像中选择重要信息的机制。<br><img src="https://raw.githubusercontent.com/Hodgeli/MarkdownPhoto/master/hashtag-microblog/Models.PNG" alt=""></p>
<h5 id="Feature-Extraction"><a href="#Feature-Extraction" class="headerlink" title="Feature Extraction"></a>Feature Extraction</h5><h6 id="Image-feature-extraction"><a href="#Image-feature-extraction" class="headerlink" title="Image feature extraction"></a>Image feature extraction</h6><p>首先将图片转换成224X224，再用16-layer VGGNet抽取特征，其中将图片分成NxN块区域每块区域获得512维的特征向量</p>
<h6 id="Text-feature-extraction"><a href="#Text-feature-extraction" class="headerlink" title="Text feature extraction"></a>Text feature extraction</h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/26/hashtag-microblog/" data-id="cl8vfrwrh001xogc5opxkmx1l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Attention-Network/">Attention Network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/读论文/">读论文</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-os1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/23/os1/" class="article-date">
  <time datetime="2018-01-23T11:05:20.000Z" itemprop="datePublished">2018-01-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/30-N天自制操作系统/">30*N天自制操作系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/23/os1/">helloos</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本来一无所有，何谈从头再来？<br>读《30天自制操作系统》笔记。第一天。</p>
<h5 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h5><p>写出操作系统二进制文件，转换成img，再通过模拟器运行。<br>手工写二进制文件太恐怖，故用汇编语言写代码，编译成操作系统二进制文件。<br>故操作系统的hello world版汇编源文件为：</p>
<h6 id="ipl-nas"><a href="#ipl-nas" class="headerlink" title="ipl.nas"></a>ipl.nas</h6><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; hello-os</span></span><br><span class="line"><span class="comment">; TAB=4</span></span><br><span class="line"></span><br><span class="line">		ORG		<span class="number">0x7c00</span>			<span class="comment">; 指明程序装载地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 标准FAT12格式软盘专用的代码 Stand FAT12 format floppy code</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">JMP</span>		entry</span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">0xeb</span>, <span class="number">0x4e</span>, <span class="number">0x90</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="string">"HELLOIPL"</span>		<span class="comment">; 启动扇区名称（8字节）</span></span><br><span class="line">		<span class="built_in">DW</span>		<span class="number">512</span>				<span class="comment">; 每个扇区（sector）大小（必须512字节）</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">1</span>				<span class="comment">; 簇（cluster）大小（必须为1个扇区）</span></span><br><span class="line">		<span class="built_in">DW</span>		<span class="number">1</span>				<span class="comment">; FAT起始位置（一般为第一个扇区）</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">2</span>				<span class="comment">; FAT个数（必须为2）</span></span><br><span class="line">		<span class="built_in">DW</span>		<span class="number">224</span>				<span class="comment">; 根目录大小（一般为224项）</span></span><br><span class="line">		<span class="built_in">DW</span>		<span class="number">2880</span>			<span class="comment">; 该磁盘大小（必须为2880扇区1440*1024/512）</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">0xf0</span>			<span class="comment">; 磁盘类型（必须为0xf0）</span></span><br><span class="line">		<span class="built_in">DW</span>		<span class="number">9</span>				<span class="comment">; FAT的长度（必??9扇区）</span></span><br><span class="line">		<span class="built_in">DW</span>		<span class="number">18</span>				<span class="comment">; 一个磁道（track）有几个扇区（必须为18）</span></span><br><span class="line">		<span class="built_in">DW</span>		<span class="number">2</span>				<span class="comment">; 磁头数（必??2）</span></span><br><span class="line">		<span class="built_in">DD</span>		<span class="number">0</span>				<span class="comment">; 不使用分区，必须是0</span></span><br><span class="line">		<span class="built_in">DD</span>		<span class="number">2880</span>			<span class="comment">; 重写一次磁盘大小</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x29</span>		<span class="comment">; 意义不明（固定）</span></span><br><span class="line">		<span class="built_in">DD</span>		<span class="number">0xffffffff</span>		<span class="comment">; （可能是）卷标号码</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="string">"HELLO-OS   "</span>	<span class="comment">; 磁盘的名称（必须为11字?，不足填空格）</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="string">"FAT12   "</span>		<span class="comment">; 磁盘格式名称（必??8字?，不足填空格）</span></span><br><span class="line">		<span class="built_in">RESB</span>	<span class="number">18</span>				<span class="comment">; 先空出18字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 程序主体</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">entry:</span></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">AX</span>,<span class="number">0</span>			<span class="comment">; 初始化寄存器</span></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">SS</span>,<span class="built_in">AX</span></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">SP</span>,<span class="number">0x7c00</span></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">DS</span>,<span class="built_in">AX</span></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">ES</span>,<span class="built_in">AX</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">SI</span>,msg</span><br><span class="line"><span class="symbol">putloop:</span></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">AL</span>,[<span class="built_in">SI</span>]</span><br><span class="line">		<span class="keyword">ADD</span>		<span class="built_in">SI</span>,<span class="number">1</span>			<span class="comment">; 给SI加1</span></span><br><span class="line">		<span class="keyword">CMP</span>		<span class="built_in">AL</span>,<span class="number">0</span></span><br><span class="line">		<span class="keyword">JE</span>		fin</span><br><span class="line">		<span class="keyword">MOV</span>		<span class="number">AH</span>,<span class="number">0x0e</span>			<span class="comment">; 显示一个文字</span></span><br><span class="line">		<span class="keyword">MOV</span>		<span class="built_in">BX</span>,<span class="number">15</span>			<span class="comment">; 指定字符颜色</span></span><br><span class="line">		<span class="keyword">INT</span>		<span class="number">0x10</span>			<span class="comment">; 调用显卡BIOS</span></span><br><span class="line">		<span class="keyword">JMP</span>		putloop</span><br><span class="line"><span class="symbol">fin:</span></span><br><span class="line">		<span class="keyword">HLT</span>						<span class="comment">; 让CPU停止，等待指令</span></span><br><span class="line">		<span class="keyword">JMP</span>		fin				<span class="comment">; 无限循环</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">msg:</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">0x0a</span>, <span class="number">0x0a</span>		<span class="comment">; 换行两次</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="string">"hello, world"</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">0x0a</span>			<span class="comment">; 换行</span></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">0</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">RESB</span>	<span class="number">0x7dfe</span>-$		<span class="comment">; 填写0x00直到0x001fe</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">DB</span>		<span class="number">0x55</span>, <span class="number">0xaa</span></span><br></pre></td></tr></table></figure>
<p>在使用光盘里提供的Makefile文件对应的 make run 命令快捷实现.nas文件编译成.bin<br>然后转换成.img最后装载到模拟器运行。在这一过程中Makefile文件里的copy 命令和 del命令<br>皆报“系统找不到指定文件”错误，对应改成cp 与 rm 命令解决。</p>
<h6 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认动作</span></span><br><span class="line"></span><br><span class="line">default :</span><br><span class="line">	<span class="built_in">..</span>/z_tools/make.exe img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像文件生成</span></span><br><span class="line"></span><br><span class="line">ipl.bin : ipl.nas Makefile</span><br><span class="line">	<span class="built_in">..</span>/z_tools/nask.exe ipl.nas ipl.bin ipl.lst</span><br><span class="line"></span><br><span class="line">helloos.img : ipl.bin Makefile</span><br><span class="line">	<span class="built_in">..</span>/z_tools/edimg.exe   imgin:<span class="built_in">..</span>/z_tools/fdimg0at.tek \</span><br><span class="line">		wbinimg src:ipl.bin len:512 <span class="keyword">from</span>:0 <span class="keyword">to</span>:0   imgout:helloos.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他指令</span></span><br><span class="line"></span><br><span class="line">asm :</span><br><span class="line">	<span class="built_in">..</span>/z_tools/make.exe -r ipl.bin</span><br><span class="line"></span><br><span class="line">img :</span><br><span class="line">	<span class="built_in">..</span>/z_tools/make.exe -r helloos.img</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">run</span> :</span><br><span class="line">	<span class="built_in">..</span>/z_tools/make.exe img</span><br><span class="line">	cp helloos.img <span class="built_in">..</span>\z_tools\qemu\fdimage0.bin</span><br><span class="line">	<span class="built_in">..</span>/z_tools/make.exe -C <span class="built_in">..</span>/z_tools/qemu</span><br><span class="line"></span><br><span class="line">install :</span><br><span class="line">	<span class="built_in">..</span>/z_tools/make.exe img</span><br><span class="line">	<span class="built_in">..</span>/z_tools/imgtol.com w a: helloos.img</span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">	-rm ipl.bin</span><br><span class="line">	-rm ipl.lst</span><br><span class="line"></span><br><span class="line">src_only :</span><br><span class="line">	<span class="built_in">..</span>/z_tools/make.exe clean</span><br><span class="line">	-rm helloos.img</span><br></pre></td></tr></table></figure>
<p>详细代码已上传至<a href="https://github.com/Hodgeli/30-N-" title="自制操作系统" target="_blank" rel="noopener">github</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/23/os1/" data-id="cl8vfrwrw0028ogc5hj8x4dtb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/os/">os</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/汇编/">汇编</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pitrain" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/16/pitrain/" class="article-date">
  <time datetime="2018-01-16T10:26:52.000Z" itemprop="datePublished">2018-01-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PyTorch笔记/">PyTorch笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/16/pitrain/">批训练&amp;优化器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>数据先Tensor化再load</p>
<h6 id="批训练-py"><a href="#批训练-py" class="headerlink" title="批训练.py"></a>批训练.py</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import</span> torch</span><br><span class="line"><span class="built_in">import</span> torch.utils.data as Data</span><br><span class="line"></span><br><span class="line">torch.manual_seed(<span class="number">1</span>)    <span class="comment"># reproducible</span></span><br><span class="line"></span><br><span class="line"><span class="attr">BATCH_SIZE</span> = <span class="number">5</span></span><br><span class="line"><span class="comment"># BATCH_SIZE = 8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">x</span> = torch.linspace(<span class="number">1</span>, <span class="number">10</span>, <span class="number">10</span>)       <span class="comment"># this is x data (torch tensor)</span></span><br><span class="line"><span class="attr">y</span> = torch.linspace(<span class="number">10</span>, <span class="number">1</span>, <span class="number">10</span>)       <span class="comment"># this is y data (torch tensor)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">torch_dataset</span> = Data.TensorDataset(<span class="attr">data_tensor=x,</span> <span class="attr">target_tensor=y)</span></span><br><span class="line"><span class="attr">loader</span> = Data.DataLoader(</span><br><span class="line">    <span class="attr">dataset=torch_dataset,</span>      <span class="comment"># torch TensorDataset format</span></span><br><span class="line">    <span class="attr">batch_size=BATCH_SIZE,</span>      <span class="comment"># mini batch size</span></span><br><span class="line">    <span class="attr">shuffle=True,</span>               <span class="comment"># random shuffle for training</span></span><br><span class="line">    <span class="attr">num_workers=2,</span>              <span class="comment"># subprocesses for loading data</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    for epoch <span class="keyword">in</span> range(<span class="number">3</span>):   <span class="comment"># train entire dataset 3 times</span></span><br><span class="line">        for step, (batch_x, batch_y) <span class="keyword">in</span> enumerate(loader):  <span class="comment"># for each training step</span></span><br><span class="line">            <span class="comment"># train your data...</span></span><br><span class="line">            print('Epoch: ', epoch, '| Step: ', step, '| batch x: ',</span><br><span class="line">                  batch_x.numpy(), '| batch y: ', batch_y.numpy())</span><br></pre></td></tr></table></figure>
<h5 id="优化器比较"><a href="#优化器比较" class="headerlink" title="优化器比较"></a>优化器比较</h5><p>在数据分批训练的基础上比较几种不同优化器的收敛效果</p>
<h6 id="优化器-py"><a href="#优化器-py" class="headerlink" title="优化器.py"></a>优化器.py</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import</span> torch</span><br><span class="line"><span class="built_in">import</span> torch.utils.data as Data</span><br><span class="line"><span class="built_in">import</span> torch.nn.functional as F</span><br><span class="line">from torch.autograd <span class="built_in">import</span> Variable</span><br><span class="line"><span class="built_in">import</span> matplotlib.pyplot as plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># torch.manual_seed(1)    # reproducible</span></span><br><span class="line"></span><br><span class="line"><span class="attr">LR</span> = <span class="number">0.01</span></span><br><span class="line"><span class="attr">BATCH_SIZE</span> = <span class="number">32</span></span><br><span class="line"><span class="attr">EPOCH</span> = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake dataset</span></span><br><span class="line"><span class="attr">x</span> = torch.unsqueeze(torch.linspace(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1000</span>), <span class="attr">dim=1)</span></span><br><span class="line"><span class="attr">y</span> = x.pow(<span class="number">2</span>) + <span class="number">0.1</span> * torch.normal(torch.zeros(*x.size()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># plot dataset</span></span><br><span class="line"><span class="comment"># plt.scatter(x.numpy(), y.numpy())</span></span><br><span class="line"><span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># put dateset into torch dataset</span></span><br><span class="line"><span class="attr">torch_dataset</span> = Data.TensorDataset(<span class="attr">data_tensor=x,</span> <span class="attr">target_tensor=y)</span></span><br><span class="line"><span class="attr">loader</span> = Data.DataLoader(<span class="attr">dataset=torch_dataset,</span> <span class="attr">batch_size=BATCH_SIZE,</span> <span class="attr">shuffle=True,</span> <span class="attr">num_workers=2,</span> )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># default network</span></span><br><span class="line">class Net(torch.nn.Module):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        super(Net, self).__init__()</span><br><span class="line">        self.<span class="attr">hidden</span> = torch.nn.Linear(<span class="number">1</span>, <span class="number">20</span>)  <span class="comment"># hidden layer</span></span><br><span class="line">        self.<span class="attr">predict</span> = torch.nn.Linear(<span class="number">20</span>, <span class="number">1</span>)  <span class="comment"># output layer</span></span><br><span class="line"></span><br><span class="line">    def forward(self, x):</span><br><span class="line">        <span class="attr">x</span> = F.relu(self.hidden(x))  <span class="comment"># activation function for hidden layer</span></span><br><span class="line">        <span class="attr">x</span> = self.predict(x)  <span class="comment"># linear output</span></span><br><span class="line">        return x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># different nets</span></span><br><span class="line"><span class="attr">net_SGD</span> = Net()</span><br><span class="line"><span class="attr">net_Momentum</span> = Net()</span><br><span class="line"><span class="attr">net_RMSprop</span> = Net()</span><br><span class="line"><span class="attr">net_Adam</span> = Net()</span><br><span class="line"><span class="attr">nets</span> = [net_SGD, net_Momentum, net_RMSprop, net_Adam]</span><br><span class="line"></span><br><span class="line"><span class="comment"># different optimizers</span></span><br><span class="line"><span class="attr">opt_SGD</span> = torch.optim.SGD(net_SGD.parameters(), <span class="attr">lr=LR)</span></span><br><span class="line"><span class="attr">opt_Momentum</span> = torch.optim.SGD(net_Momentum.parameters(), <span class="attr">lr=LR,</span> <span class="attr">momentum=0.8)</span></span><br><span class="line"><span class="attr">opt_RMSprop</span> = torch.optim.RMSprop(net_RMSprop.parameters(), <span class="attr">lr=LR,</span> <span class="attr">alpha=0.9)</span></span><br><span class="line"><span class="attr">opt_Adam</span> = torch.optim.Adam(net_Adam.parameters(), <span class="attr">lr=LR,</span> <span class="attr">betas=(0.9,</span> <span class="number">0.99</span>))</span><br><span class="line"><span class="attr">optimizers</span> = [opt_SGD, opt_Momentum, opt_RMSprop, opt_Adam]</span><br><span class="line"></span><br><span class="line"><span class="attr">loss_func</span> = torch.nn.MSELoss()</span><br><span class="line"><span class="attr">losses_his</span> = [[], [], [], []]  <span class="comment"># record loss</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># training</span></span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    for epoch <span class="keyword">in</span> range(EPOCH):</span><br><span class="line">        print('Epoch: ', epoch)</span><br><span class="line">        for step, (batch_x, batch_y) <span class="keyword">in</span> enumerate(loader):  <span class="comment"># for each training step</span></span><br><span class="line">            <span class="attr">b_x</span> = Variable(batch_x)</span><br><span class="line">            <span class="attr">b_y</span> = Variable(batch_y)</span><br><span class="line"></span><br><span class="line">            for net, opt, l_his <span class="keyword">in</span> zip(nets, optimizers, losses_his):</span><br><span class="line">                <span class="attr">output</span> = net(b_x)  <span class="comment"># get output for every net</span></span><br><span class="line">                <span class="attr">loss</span> = loss_func(output, b_y)  <span class="comment"># compute loss for every net</span></span><br><span class="line">                opt.zero_grad()  <span class="comment"># clear gradients for next train</span></span><br><span class="line">                loss.backward()  <span class="comment"># backpropagation, compute gradients</span></span><br><span class="line">                opt.step()  <span class="comment"># apply gradients</span></span><br><span class="line">                l_his.append(loss.data[<span class="number">0</span>])  <span class="comment"># loss recoder</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">labels</span> = ['SGD', 'Momentum', 'RMSprop', 'Adam']</span><br><span class="line">    for i, l_his <span class="keyword">in</span> enumerate(losses_his):</span><br><span class="line">        plt.plot(l_his, <span class="attr">label=labels[i])</span></span><br><span class="line">    plt.legend(<span class="attr">loc='best')</span></span><br><span class="line">    plt.xlabel('Steps')</span><br><span class="line">    plt.ylabel('Loss')</span><br><span class="line">    plt.ylim((<span class="number">0</span>, <span class="number">0.2</span>))</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/16/pitrain/" data-id="cl8vfrwrw002fogc55nwtlbnp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pytorch/">pytorch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/笔记/">笔记</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-lda" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/16/lda/" class="article-date">
  <time datetime="2018-01-16T06:32:21.000Z" itemprop="datePublished">2018-01-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工具积累/">工具积累</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/16/lda/">LDA主题模型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><p>爬到的推文做主题分析<br>方法引用自博客：<a href="http://blog.csdn.net/github_36299736/article/details/54966460" target="_blank" rel="noopener">http://blog.csdn.net/github_36299736/article/details/54966460</a></p>
<p>简单例子：</p>
<h6 id="LDA-demo-py"><a href="#LDA-demo-py" class="headerlink" title="LDA_demo.py"></a>LDA_demo.py</h6><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LDA 例子测试</span></span><br><span class="line">from nltk.tokenize <span class="built_in">import</span> RegexpTokenizer</span><br><span class="line">from stop_words <span class="built_in">import</span> get_stop_words</span><br><span class="line">from nltk.stem.porter <span class="built_in">import</span> PorterStemmer</span><br><span class="line">from gensim <span class="built_in">import</span> corpora, models</span><br><span class="line"><span class="built_in">import</span> gensim</span><br><span class="line"></span><br><span class="line"><span class="attr">tokenizer</span> = RegexpTokenizer(r'\w+')</span><br><span class="line"></span><br><span class="line"><span class="comment"># create English stop words list</span></span><br><span class="line"><span class="attr">en_stop</span> = get_stop_words('en')</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create p_stemmer of class PorterStemmer</span></span><br><span class="line"><span class="attr">p_stemmer</span> = PorterStemmer()</span><br><span class="line"></span><br><span class="line"><span class="comment"># create sample documents</span></span><br><span class="line"><span class="attr">doc_a</span> = <span class="string">"Brocolli is good to eat. My brother likes to eat good brocolli, but not my mother."</span></span><br><span class="line"><span class="attr">doc_b</span> = <span class="string">"My mother spends a lot of time driving my brother around to baseball practice."</span></span><br><span class="line"><span class="attr">doc_c</span> = <span class="string">"Some health experts suggest that driving may cause increased tension and blood pressure."</span></span><br><span class="line"><span class="attr">doc_d</span> = <span class="string">"I often feel pressure to perform well at school, but my mother never seems to drive my brother to do better."</span></span><br><span class="line"><span class="attr">doc_e</span> = <span class="string">"Health professionals say that brocolli is good for your health."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># compile sample documents into a list</span></span><br><span class="line"><span class="attr">doc_set</span> = [doc_a, doc_b, doc_c, doc_d, doc_e]</span><br><span class="line"></span><br><span class="line"><span class="comment"># list for tokenized documents in loop</span></span><br><span class="line"><span class="attr">texts</span> = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># loop through document list</span></span><br><span class="line">for i <span class="keyword">in</span> doc_set:</span><br><span class="line">    <span class="comment"># clean and tokenize document string</span></span><br><span class="line">    <span class="attr">raw</span> = i.lower()</span><br><span class="line">    <span class="attr">tokens</span> = tokenizer.tokenize(raw)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># remove stop words from tokens</span></span><br><span class="line">    <span class="attr">stopped_tokens</span> = [i for i <span class="keyword">in</span> tokens <span class="keyword">if</span> not i <span class="keyword">in</span> en_stop]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># stem tokens</span></span><br><span class="line">    <span class="attr">stemmed_tokens</span> = [p_stemmer.stem(i) for i <span class="keyword">in</span> stopped_tokens]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add tokens to list</span></span><br><span class="line">    texts.append(stemmed_tokens)</span><br><span class="line"></span><br><span class="line"><span class="comment"># turn our tokenized documents into a id &lt;-&gt; term dictionary</span></span><br><span class="line"><span class="attr">dictionary</span> = corpora.Dictionary(texts)</span><br><span class="line"></span><br><span class="line"><span class="comment"># convert tokenized documents into a document-term matrix</span></span><br><span class="line"><span class="attr">corpus</span> = [dictionary.doc2bow(text) for text <span class="keyword">in</span> texts]</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate LDA model</span></span><br><span class="line"><span class="attr">ldamodel</span> = gensim.models.ldamodel.LdaModel(corpus, <span class="attr">num_topics=2,</span> <span class="attr">id2word</span> = dictionary, <span class="attr">passes=20)</span></span><br><span class="line"></span><br><span class="line">print(ldamodel.print_topics(<span class="attr">num_topics=2,</span> <span class="attr">num_words=4))</span></span><br></pre></td></tr></table></figure>
<h5 id="实现分析"><a href="#实现分析" class="headerlink" title="实现分析"></a>实现分析</h5><p>最后的实现代码来自：<a href="https://github.com/a55509432/python-LDA" target="_blank" rel="noopener">https://github.com/a55509432/python-LDA</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/16/lda/" data-id="cl8vfrwrh001vogc52urb0g1m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lda/">lda</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-get-twitters" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/14/get-twitters/" class="article-date">
  <time datetime="2018-01-14T02:46:20.000Z" itemprop="datePublished">2018-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工具积累/">工具积累</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/14/get-twitters/">twitter爬虫2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><p>利用tweepy和hashtag爬取推文（每个hash拿500条左右）<br>对推文进行文本处理：去非英文字符、去链接、去hash、去中止词<br>以hash:twitter形式存字典再存文件：dict_hash_twitter</p>
<h5 id="推文采集"><a href="#推文采集" class="headerlink" title="推文采集"></a>推文采集</h5><p>由于国内网络环境问题，还是把每个hash对应的推文保存成文件再处理，稳点起见。<br>事实证明，用tweepy包的search方法会有访问频率限制，但我申请了四个twitter app<br>轮回换key还是能实现不间断下载的</p>
<h6 id="get-twitter-py"><a href="#get-twitter-py" class="headerlink" title="get_twitter.py"></a>get_twitter.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tweepy</span><br><span class="line"><span class="keyword">from</span> tweepy <span class="keyword">import</span> OAuthHandler</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">list_consumer_key = [<span class="string">'########################'</span>, <span class="string">'########################'</span>, <span class="string">'########################'</span>,</span><br><span class="line">                     <span class="string">'########################'</span>]</span><br><span class="line">list_consumer_secret = [<span class="string">'########################'</span>,</span><br><span class="line">                        <span class="string">'########################'</span>,</span><br><span class="line">                        <span class="string">'########################'</span>,</span><br><span class="line">                        <span class="string">'########################'</span>]</span><br><span class="line">list_access_token = [<span class="string">'########################-########################'</span>,</span><br><span class="line">                     <span class="string">'########################-########################'</span>,</span><br><span class="line">                     <span class="string">'########################-########################'</span>,</span><br><span class="line">                     <span class="string">'########################-########################'</span>]</span><br><span class="line">list_access_secret = [<span class="string">'########################'</span>, <span class="string">'########################'</span>,</span><br><span class="line">                      <span class="string">'########################'</span>, <span class="string">'########################'</span>]</span><br><span class="line"></span><br><span class="line">num_key = <span class="number">0</span></span><br><span class="line">consumer_key = list_consumer_key[num_key]</span><br><span class="line">consumer_secret = list_consumer_secret[num_key]</span><br><span class="line">access_token = list_access_token[num_key]</span><br><span class="line">access_secret = list_access_secret[num_key]</span><br><span class="line"></span><br><span class="line">auth = OAuthHandler(consumer_key, consumer_secret)</span><br><span class="line">auth.set_access_token(access_token, access_secret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># api = tweepy.API(auth) # 不使用代理</span></span><br><span class="line">api = tweepy.API(auth, proxy=<span class="string">"127.0.0.1:1080"</span>)</span><br><span class="line"></span><br><span class="line">f_hash = open(<span class="string">"count_hash.txt"</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">list_hash = []</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line_hash = f_hash.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_hash:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        list_hash.append(str(re.findall(<span class="string">r"'(.*?)'"</span>, line_hash, flags=<span class="number">0</span>)[<span class="number">0</span>]))</span><br><span class="line">print(<span class="string">'list_hash生成成功：'</span> + str(len(list_hash)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> id <span class="keyword">in</span> range(<span class="number">1056</span>, len(list_hash)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        query = str(list_hash[id])</span><br><span class="line">        print(query)</span><br><span class="line">        <span class="comment"># 获取推文</span></span><br><span class="line">        tweets = tweepy.Cursor(api.search, q=query, count=<span class="number">100</span>, lang=<span class="string">'en'</span>, include_entities=<span class="keyword">False</span>).items(<span class="number">300</span>)</span><br><span class="line">        f_twitter = open(<span class="string">"./hash_twitter/"</span> + str(list_hash[id]), <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> tweet <span class="keyword">in</span> tweets:</span><br><span class="line">            f_twitter.write(str(tweet.text).replace(<span class="string">'\n'</span>, <span class="string">' '</span>) + <span class="string">'\n'</span>)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">300</span>):</span><br><span class="line">            f_short_hash = open(<span class="string">"short_hash.txt"</span>, <span class="string">'a'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">            f_short_hash.write(str(list_hash[id]) + <span class="string">'\n'</span>)</span><br><span class="line">            f_short_hash.close()</span><br><span class="line">        print(id)</span><br><span class="line">    <span class="keyword">except</span>(TypeError, tweepy.error.TweepError):</span><br><span class="line">        print(str(list_hash[id]) + <span class="string">'爬取失败'</span>)</span><br><span class="line">        f_error_hash = open(<span class="string">"error_hash.txt"</span>, <span class="string">'a'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">        f_error_hash.write(str(list_hash[id]) + <span class="string">'\n'</span>)</span><br><span class="line">        f_error_hash.close()</span><br><span class="line">        <span class="comment"># 更换key</span></span><br><span class="line">        num_key += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (num_key == <span class="number">4</span>):</span><br><span class="line">            num_key = <span class="number">0</span></span><br><span class="line">        consumer_key = list_consumer_key[num_key]</span><br><span class="line">        consumer_secret = list_consumer_secret[num_key]</span><br><span class="line">        access_token = list_access_token[num_key]</span><br><span class="line">        access_secret = list_access_secret[num_key]</span><br><span class="line"></span><br><span class="line">        auth = OAuthHandler(consumer_key, consumer_secret)</span><br><span class="line">        auth.set_access_token(access_token, access_secret)</span><br><span class="line"></span><br><span class="line">        api = tweepy.API(auth, proxy=<span class="string">"127.0.0.1:1080"</span>)</span><br><span class="line">        print(<span class="string">'key更换成功，继续下载-------------------------&gt;'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h5><p>下载好的文件是多行的推文<br>需要对推文进行文本处理：去非英文字符、去链接、去hash、去中止词<br>然后以hash为文件名以一行处理后的推文为内容存文件</p>
<h6 id="clean-data-py"><a href="#clean-data-py" class="headerlink" title="clean_data.py"></a>clean_data.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hashs</span><span class="params">(template)</span>:</span>  <span class="comment"># HashTag以‘#’开头，以空格或回车结尾</span></span><br><span class="line">    copy = <span class="keyword">False</span></span><br><span class="line">    finished = <span class="keyword">False</span></span><br><span class="line">    slotList = []</span><br><span class="line">    str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> template:</span><br><span class="line">        <span class="keyword">if</span> s == <span class="string">'#'</span>:</span><br><span class="line">            copy = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> s == <span class="string">' '</span>:</span><br><span class="line">            copy = <span class="keyword">False</span></span><br><span class="line">            finished = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> s == <span class="string">'\n'</span>:</span><br><span class="line">            copy = <span class="keyword">False</span></span><br><span class="line">            finished = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> copy:</span><br><span class="line">            str = str + s</span><br><span class="line">        <span class="keyword">if</span> finished:</span><br><span class="line">            <span class="keyword">if</span> str != <span class="string">""</span>:</span><br><span class="line">                slotList.append(str)</span><br><span class="line">            str = <span class="string">""</span></span><br><span class="line">            finished = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">return</span> slotList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_name</span><span class="params">(file_dir)</span>:</span>  <span class="comment"># 获取视频名list</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(file_dir):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_alpha</span><span class="params">(word)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> word.encode(<span class="string">'ascii'</span>).isalpha()</span><br><span class="line">    <span class="keyword">except</span> UnicodeEncodeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f_stop_word = open(<span class="string">"stop_word.txt"</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">list_stop_word = []</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line_stop_word = f_stop_word.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_stop_word:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        list_stop_word.append(str(line_stop_word).replace(<span class="string">"\n"</span>, <span class="string">''</span>).lower())</span><br><span class="line">print(<span class="string">"停用词列表生成成功:"</span> + str(len(list_stop_word)))</span><br><span class="line"></span><br><span class="line">list_hash_down = file_name(<span class="string">r'I:\推荐系统\数据集\twitter\hash_twitter'</span>)</span><br><span class="line">print(len(list_hash_down))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> hash <span class="keyword">in</span> list_hash_down:</span><br><span class="line">    f_twitter = open(<span class="string">'./hash_twitter/'</span> + hash, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    long_str = <span class="string">''</span></span><br><span class="line">    <span class="comment"># for i in range(1, 10):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        line_twitter = f_twitter.readline()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line_twitter:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            line_twitter = re.sub(<span class="string">r'#\w* '</span>, <span class="string">''</span>, line_twitter)</span><br><span class="line">            line_twitter = re.sub(<span class="string">r'#\w*\n'</span>, <span class="string">''</span>, line_twitter)</span><br><span class="line">            line_twitter = re.sub(<span class="string">r'https\S* '</span>, <span class="string">''</span>, line_twitter)</span><br><span class="line">            line_twitter = re.sub(<span class="string">r'https\S*\n'</span>, <span class="string">''</span>, line_twitter)</span><br><span class="line">            text_final = <span class="string">''</span></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> line_twitter:</span><br><span class="line">                <span class="keyword">if</span> is_alpha(s):</span><br><span class="line">                    text_final += s</span><br><span class="line">                <span class="keyword">elif</span> s == <span class="string">' '</span> <span class="keyword">or</span> s == <span class="string">'-'</span> <span class="keyword">or</span> s == <span class="string">'~'</span>:</span><br><span class="line">                    text_final += <span class="string">' '</span>  <span class="comment"># 去除非英文字符，保留空格</span></span><br><span class="line">            text_final = re.sub(<span class="string">r'\s+'</span>, <span class="string">' '</span>, text_final)</span><br><span class="line">            line_twitter = text_final.lower()</span><br><span class="line">            list_word = line_twitter.split(<span class="string">' '</span>)  <span class="comment"># 分词，包含空字符</span></span><br><span class="line">            text_final = <span class="string">''</span></span><br><span class="line">            <span class="keyword">for</span> word <span class="keyword">in</span> list_word:</span><br><span class="line">                <span class="keyword">if</span> word == <span class="string">''</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">elif</span> word <span class="keyword">not</span> <span class="keyword">in</span> list_stop_word:  <span class="comment"># 去除中止词</span></span><br><span class="line">                    text_final += word + <span class="string">' '</span></span><br><span class="line">            long_str += text_final</span><br><span class="line">    f_twitter.close()</span><br><span class="line">    long_str = re.sub(<span class="string">r'\n'</span>, <span class="string">''</span>, long_str)</span><br><span class="line">    long_str = re.sub(<span class="string">r'\s+'</span>, <span class="string">' '</span>, long_str)</span><br><span class="line">    list_word = long_str.split(<span class="string">' '</span>)</span><br><span class="line">    <span class="keyword">if</span> (len(list_word) &lt; <span class="number">10</span>):</span><br><span class="line">        print(str(hash) + <span class="string">'太短'</span>)</span><br><span class="line">        f_short_result = open(<span class="string">'short_result'</span>, <span class="string">'a'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">        f_short_result.write(str(hash) + <span class="string">'\n'</span>)</span><br><span class="line">        f_short_result.close()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        f_twitter_new = open(<span class="string">'./hash_twitter_new/'</span> + hash, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">        f_twitter_new.write(long_str)</span><br><span class="line">        f_twitter_new.close()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/14/get-twitters/" data-id="cl8vfrwqm0015ogc5b9uq9n57" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/twitter/">twitter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/爬虫/">爬虫</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-feature-extract" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/14/feature-extract/" class="article-date">
  <time datetime="2018-01-14T02:40:01.000Z" itemprop="datePublished">2018-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/神经网络/">神经网络</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/14/feature-extract/">数据特征提取</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在上文处理好的数据集上利用AlexNet和word2vec提取数据特征</p>
<h6 id="test-hdf5-librosa-py"><a href="#test-hdf5-librosa-py" class="headerlink" title="test_hdf5_librosa.py"></a>test_hdf5_librosa.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> h5py</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models, transforms</span><br><span class="line"><span class="keyword">import</span> librosa</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">import</span> gensim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------prepare for extract feature--------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------get Alexnet model-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAlexNet</span><span class="params">(DOWNLOAD=True)</span>:</span></span><br><span class="line">    alexnet = models.alexnet(pretrained=DOWNLOAD)</span><br><span class="line">    <span class="keyword">return</span> alexnet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------revise the AlexNet class--------------------------</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlexNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(AlexNet, self).__init__()</span><br><span class="line">        self.features = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">3</span>, <span class="number">64</span>, kernel_size=<span class="number">11</span>, stride=<span class="number">4</span>, padding=<span class="number">2</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">64</span>, <span class="number">192</span>, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">192</span>, <span class="number">384</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">384</span>, <span class="number">256</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line">        self.classifier = nn.Sequential(</span><br><span class="line">            nn.Dropout(),</span><br><span class="line">            nn.Linear(<span class="number">256</span> * <span class="number">6</span> * <span class="number">6</span>, <span class="number">4096</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">            nn.Dropout(),</span><br><span class="line">            nn.Linear(<span class="number">4096</span>, <span class="number">4096</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.features(x)</span><br><span class="line">        x = x.view(x.size(<span class="number">0</span>), <span class="number">256</span> * <span class="number">6</span> * <span class="number">6</span>)</span><br><span class="line">        x = self.classifier(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------create the dataset class--------------------------</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageDataset</span><span class="params">(Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, img_path, transform=None)</span>:</span></span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.images = list(map(<span class="keyword">lambda</span> x: os.path.join(img_path, x), os.listdir(img_path)))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        image_file = self.images[index]</span><br><span class="line">        image = Image.open(image_file).convert(<span class="string">'RGB'</span>)</span><br><span class="line">        <span class="keyword">if</span> self.transform <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            image = self.transform(image)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.images)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------create the dataloader--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dataset</span><span class="params">(path, img_scale, batch_size)</span>:</span></span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.Scale(img_scale),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize(mean=[<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>],</span><br><span class="line">                             std=[<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>])</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    dataset = ImageDataset(path, transform)</span><br><span class="line">    data_loader = DataLoader(dataset=dataset,</span><br><span class="line">                             batch_size=batch_size,</span><br><span class="line">                             shuffle=<span class="keyword">False</span>,</span><br><span class="line">                             drop_last=<span class="keyword">True</span>)</span><br><span class="line">    <span class="keyword">return</span> data_loader</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------begin to extract feature--------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">text_file</span><span class="params">(path, h5base, id, model)</span>:</span></span><br><span class="line">    finnal_matrix = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">with</span> open(path + <span class="string">'text.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        texts = f.read()</span><br><span class="line">    text_list = texts.strip().split(<span class="string">" "</span>)</span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> text_list:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            vec_word = model[word]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            vec_word = np.zeros(<span class="number">300</span>)</span><br><span class="line">        vec_word = vec_word.reshape(<span class="number">300</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> finnal_matrix <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            finnal_matrix = vec_word</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            finnal_matrix = np.concatenate((finnal_matrix, vec_word), axis=<span class="number">1</span>)</span><br><span class="line">        h5base.create_dataset(id, data=finnal_matrix)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------get image feature and store--------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image_file</span><span class="params">(path, h5base, id, model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param path: file path</span></span><br><span class="line"><span class="string">    :param h5base: store 12 * 4096 data</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        img_scale = <span class="number">224</span></span><br><span class="line">        batch_size = <span class="number">12</span></span><br><span class="line">        data_loader = get_dataset(path, img_scale, batch_size)</span><br><span class="line">        <span class="keyword">for</span> _, data <span class="keyword">in</span> enumerate(data_loader):</span><br><span class="line">            <span class="comment"># use model to extract feature</span></span><br><span class="line">            features = model(Variable(data))</span><br><span class="line">        <span class="comment"># save features</span></span><br><span class="line">        h5base.create_dataset(id, data=features.data.numpy())</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(id + <span class="string">"在图像上出现了有问题！"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------get audio feature and store--------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">audio_file</span><span class="params">(path, h5base, id)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param path: file path</span></span><br><span class="line"><span class="string">    :param h5base: store 6 * 512 data</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        finnal_matrix = <span class="keyword">None</span></span><br><span class="line">        use_audio = [<span class="string">"1.mp3"</span>, <span class="string">"2.mp3"</span>, <span class="string">"3.mp3"</span>, <span class="string">"4.mp3"</span>, <span class="string">"5.mp3"</span>, <span class="string">"6.mp3"</span>]</span><br><span class="line">        files = librosa.util.find_files(path, recurse=<span class="keyword">False</span>, ext=<span class="string">'mp3'</span>)</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            file_list = file.split(<span class="string">"/"</span>)</span><br><span class="line">            <span class="keyword">if</span> file_list[<span class="number">-1</span>] <span class="keyword">not</span> <span class="keyword">in</span> use_audio:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            y, sr = librosa.load(file)</span><br><span class="line">            D = librosa.stft(y, n_fft=<span class="number">1022</span>)</span><br><span class="line">            vec_D = np.mean(D, axis=<span class="number">1</span>, keepdims=<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">if</span> finnal_matrix <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                finnal_matrix = vec_D</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                finnal_matrix = np.concatenate((finnal_matrix, vec_D), axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># judge final matrix shape</span></span><br><span class="line">        <span class="keyword">if</span> finnal_matrix <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> finnal_matrix.shape != (<span class="number">512</span>, <span class="number">6</span>):</span><br><span class="line">            print(id + <span class="string">"有问题！"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        h5base.create_dataset(id, data=finnal_matrix)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(id + <span class="string">"在音频上出现了有问题！"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------get audio feature and store--------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># some config variable</span></span><br><span class="line">    root_path = <span class="string">"./dataset1/"</span></span><br><span class="line">    DOWNLOAD = <span class="keyword">False</span></span><br><span class="line">    pre_train_weight_alexnet = <span class="string">"./alexnet-owt-4df8aa71.pth"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># create h5py file</span></span><br><span class="line">    restore_audio_file = h5py.File(<span class="string">"dataset1_audio_feature.hdf5"</span>, <span class="string">"w"</span>)</span><br><span class="line">    restore_images_file = h5py.File(<span class="string">"dataset1_images_feature.hdf5"</span>, <span class="string">"w"</span>)</span><br><span class="line">    restore_texts_file = h5py.File(<span class="string">"dataset1_texts_feature.hdf5"</span>, <span class="string">"w"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># -----------------get Alexnet to extrat imgs features--------------------------</span></span><br><span class="line">    <span class="comment"># if you alread download the weight, we can make DOWNLOAD = False</span></span><br><span class="line">    pre_alexnet = getAlexNet(DOWNLOAD)</span><br><span class="line">    pre_alexnet.load_state_dict(torch.load(pre_train_weight_alexnet))</span><br><span class="line">    pretrain_dict = pre_alexnet.state_dict()</span><br><span class="line"></span><br><span class="line">    alexnet = AlexNet()</span><br><span class="line">    alexnet_dict = alexnet.state_dict()</span><br><span class="line">    pretrained_dict = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> pretrain_dict.items() <span class="keyword">if</span> k <span class="keyword">in</span> alexnet_dict&#125;</span><br><span class="line">    <span class="comment"># update the weight of new alexnet</span></span><br><span class="line">    alexnet_dict.update(pretrained_dict)</span><br><span class="line">    <span class="comment"># load the new weight</span></span><br><span class="line">    alexnet.load_state_dict(alexnet_dict)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># -----------------get word2vec by Google to extrat texts features--------------------------</span></span><br><span class="line">    word2vec = gensim.models.KeyedVectors.load_word2vec_format(<span class="string">"./GoogleNews-vectors-negative300.bin"</span>, binary=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># go to the dir and loop</span></span><br><span class="line">    dirs = os.listdir(root_path)</span><br><span class="line">    process = <span class="number">0</span></span><br><span class="line">    total = len(dirs)</span><br><span class="line">    <span class="keyword">for</span> dir <span class="keyword">in</span> dirs:</span><br><span class="line">        audio_file(root_path + dir + <span class="string">"/audios/"</span>, restore_audio_file, dir)</span><br><span class="line">        image_file(root_path + dir + <span class="string">"/images/"</span>, restore_images_file, dir, alexnet)</span><br><span class="line">        text_file(root_path + dir + <span class="string">"/texts/"</span>, restore_texts_file, dir, word2vec)</span><br><span class="line">        process += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> process % (total // <span class="number">10</span>) == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">"alread down"</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Done!"</span>)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/14/feature-extract/" data-id="cl8vfrwr1001cogc5uhnhcxzf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AlexNet/">AlexNet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/神经网络/">神经网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-torch-save" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/09/torch-save/" class="article-date">
  <time datetime="2018-01-09T12:32:41.000Z" itemprop="datePublished">2018-01-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PyTorch笔记/">PyTorch笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/09/torch-save/">保存提取</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="保存提取"><a href="#保存提取" class="headerlink" title="保存提取"></a>保存提取</h5><p>训练好了一个模型, 我们当然想要保存它, 留到下次要用的时候直接提取直接用</p>
<h6 id="保存提取-py"><a href="#保存提取-py" class="headerlink" title="保存提取.py"></a>保存提取.py</h6><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="title">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># fake data</span></span><br><span class="line"><span class="title">x</span> = torch.unsqueeze(torch.linspace(<span class="number">-1</span>, <span class="number">1</span>, <span class="number">100</span>), dim=<span class="number">1</span>)  # x <span class="class"><span class="keyword">data</span> (<span class="title">tensor</span>), shape=(100, 1)</span></span><br><span class="line"><span class="title">y</span> = x.pow(<span class="number">2</span>) + <span class="number">0.2</span> * torch.rand(x.size())  # noisy y <span class="class"><span class="keyword">data</span> (<span class="title">tensor</span>), shape=(100, 1)</span></span><br><span class="line"><span class="title">x</span>, y = <span class="type">Variable</span>(x, requires_grad=<span class="type">False</span>), <span class="type">Variable</span>(y, requires_grad=<span class="type">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">def</span> save():</span><br><span class="line">    # save net1</span><br><span class="line">    net1 = torch.nn.<span class="type">Sequential</span>(</span><br><span class="line">        torch.nn.<span class="type">Linear</span>(<span class="number">1</span>, <span class="number">10</span>),</span><br><span class="line">        torch.nn.<span class="type">ReLU</span>(),</span><br><span class="line">        torch.nn.<span class="type">Linear</span>(<span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line">    )</span><br><span class="line">    optimizer = torch.optim.<span class="type">SGD</span>(net1.parameters(), lr=<span class="number">0.5</span>)</span><br><span class="line">    loss_func = torch.nn.<span class="type">MSELoss</span>()</span><br><span class="line"></span><br><span class="line">    for t <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        prediction = net1(x)</span><br><span class="line">        loss = loss_func(prediction, y)</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">    # plot result</span><br><span class="line">    plt.figure(<span class="number">1</span>, figsize=(<span class="number">10</span>, <span class="number">3</span>))</span><br><span class="line">    plt.subplot(<span class="number">131</span>)</span><br><span class="line">    plt.title('<span class="type">Net1'</span>)</span><br><span class="line">    plt.scatter(x.<span class="class"><span class="keyword">data</span>.numpy(), y.<span class="keyword">data</span>.numpy())</span></span><br><span class="line">    plt.plot(x.<span class="class"><span class="keyword">data</span>.numpy(), prediction.<span class="keyword">data</span>.numpy(), 'r-', lw=5)</span></span><br><span class="line"></span><br><span class="line">    # <span class="number">2</span> ways to save the net</span><br><span class="line">    torch.save(net1, 'net.pkl')  # save entire net</span><br><span class="line">    torch.save(net1.state_dict(), 'net_params.pkl')  # save only the parameters</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">def</span> restore_net():</span><br><span class="line">    # restore entire net1 to net2</span><br><span class="line">    net2 = torch.load('net.pkl')</span><br><span class="line">    prediction = net2(x)</span><br><span class="line"></span><br><span class="line">    # plot result</span><br><span class="line">    plt.subplot(<span class="number">132</span>)</span><br><span class="line">    plt.title('<span class="type">Net2'</span>)</span><br><span class="line">    plt.scatter(x.<span class="class"><span class="keyword">data</span>.numpy(), y.<span class="keyword">data</span>.numpy())</span></span><br><span class="line">    plt.plot(x.<span class="class"><span class="keyword">data</span>.numpy(), prediction.<span class="keyword">data</span>.numpy(), 'r-', lw=5)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">def</span> restore_params():</span><br><span class="line">    # restore only the parameters <span class="keyword">in</span> net1 to net3</span><br><span class="line">    net3 = torch.nn.<span class="type">Sequential</span>(</span><br><span class="line">        torch.nn.<span class="type">Linear</span>(<span class="number">1</span>, <span class="number">10</span>),</span><br><span class="line">        torch.nn.<span class="type">ReLU</span>(),</span><br><span class="line">        torch.nn.<span class="type">Linear</span>(<span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # copy net1's parameters into net3</span><br><span class="line">    net3.load_state_dict(torch.load('net_params.pkl'))</span><br><span class="line">    prediction = net3(x)</span><br><span class="line">    # plot result</span><br><span class="line">    plt.subplot(<span class="number">133</span>)</span><br><span class="line">    plt.title('<span class="type">Net3'</span>)</span><br><span class="line">    plt.scatter(x.<span class="class"><span class="keyword">data</span>.numpy(), y.<span class="keyword">data</span>.numpy())</span></span><br><span class="line">    plt.plot(x.<span class="class"><span class="keyword">data</span>.numpy(), prediction.<span class="keyword">data</span>.numpy(), 'r-', lw=5)</span></span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># save net1</span></span><br><span class="line"><span class="title">save</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta"># restore entire net (may slow)</span></span><br><span class="line"><span class="title">restore_net</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta"># restore only the net parameters</span></span><br><span class="line"><span class="title">restore_params</span>()</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/09/torch-save/" data-id="cl8vfrwt7003logc5w9pue3rq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pytorch/">pytorch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/笔记/">笔记</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-clean-down-data" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/09/clean-down-data/" class="article-date">
  <time datetime="2018-01-09T02:06:36.000Z" itemprop="datePublished">2018-01-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python踩坑指南/">Python踩坑指南</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/09/clean-down-data/">vine数据集处理4</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="需求-amp-前提"><a href="#需求-amp-前提" class="headerlink" title="需求&amp;前提"></a>需求&amp;前提</h5><p>多个文件夹的视频文件共121117-1862（下载失败数）= 119255 条<br>多个文件夹的分割后文件共119255 - 135（分割失败数）= 119120 条<br>现要对这119120条数据做hash词频统计，并截取词频不小于5的所有数据并清除不合法数据</p>
<p>求得分割后数据数:<br>遍历video文件夹建立list_id并去除extract_fail数据</p>
<h6 id="get-all-videos-py"><a href="#get-all-videos-py" class="headerlink" title="get_all_videos.py"></a>get_all_videos.py</h6><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取所有拆分成功的短视频id存入list_id.txt</span></span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def file_name(file_dir):  <span class="comment"># 获取视频名list</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, <span class="built_in">files</span> <span class="keyword">in</span> os.walk(file_dir):</span><br><span class="line">        continue</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">files</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">path = <span class="string">'/home/caoda/Hodge_work_space/videos_data/videos_201712'</span></span><br><span class="line">list_id = []</span><br><span class="line">f_list_id = <span class="built_in">open</span>(<span class="string">"list_id.txt"</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line"><span class="keyword">a</span> = f_list_id.<span class="built_in">read</span>()</span><br><span class="line">list_id = eval(<span class="keyword">a</span>)</span><br><span class="line">f_list_id.<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'读取list_id成功，现有'</span> + str(<span class="built_in">len</span>(list_id)) + <span class="string">'条数据'</span>)</span><br><span class="line">list_path = [<span class="string">'07'</span>, <span class="string">'08'</span>, <span class="string">'09'</span>, <span class="string">'10'</span>, <span class="string">'11'</span>, <span class="string">'12'</span>, <span class="string">'13'</span>, <span class="string">'14'</span>, <span class="string">'15'</span>, <span class="string">'16'</span>, <span class="string">'18'</span>, <span class="string">'19'</span>, <span class="string">'20'</span>, <span class="string">'21'</span>, <span class="string">'24'</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> list_path:</span><br><span class="line">    list_id += file_name(path + i)</span><br><span class="line">    <span class="comment"># print(path + str(i))</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'总视频数：'</span> + str(<span class="built_in">len</span>(list_id)))  <span class="comment"># 121117条数据-下载失败条数</span></span><br><span class="line"><span class="comment"># 去除提取失败与剩余条数</span></span><br><span class="line"></span><br><span class="line">f_extract_fail = <span class="built_in">open</span>(<span class="string">"extract_fail"</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line_extract_fail = f_extract_fail.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_extract_fail:</span><br><span class="line">        break</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        line_extract_fail = line_extract_fail.<span class="built_in">replace</span>(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> (line_extract_fail <span class="keyword">in</span> list_id):</span><br><span class="line">            list_id.remove(line_extract_fail)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'清理'</span> + str(i) + <span class="string">'条数据\n最后总数据'</span> + str(<span class="built_in">len</span>(list_id)))</span><br><span class="line"></span><br><span class="line">f_list_id = <span class="built_in">open</span>(<span class="string">"list_id.txt"</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">f_list_id.<span class="built_in">write</span>(str(list_id))</span><br><span class="line">f_list_id.<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">list_id.<span class="built_in">clear</span>()</span><br></pre></td></tr></table></figure>
<h5 id="词频统计"><a href="#词频统计" class="headerlink" title="词频统计"></a>词频统计</h5><p>根据list_id和121117长度的final_hashs.txt对最终数据做词频统计写入count_hash.txt</p>
<h6 id="count-py"><a href="#count-py" class="headerlink" title="count.py"></a>count.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统计hash总数与词频</span></span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_id</span><span class="params">(template)</span>:</span></span><br><span class="line">    rule = <span class="string">r'(.*?)::::'</span></span><br><span class="line">    slot_list = re.findall(rule, template)</span><br><span class="line">    <span class="keyword">return</span> slot_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_text</span><span class="params">(template)</span>:</span></span><br><span class="line">    rule = <span class="string">r'::::(.*?)\n'</span></span><br><span class="line">    slot_list = re.findall(rule, template)</span><br><span class="line">    <span class="keyword">return</span> slot_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_list_or_dict</span><span class="params">(path)</span>:</span></span><br><span class="line">    f = open(path, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    a = f.read()</span><br><span class="line">    dict_or_list = eval(a)</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> dict_or_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">list_id = get_list_or_dict(<span class="string">'list_id.txt'</span>)</span><br><span class="line">print(<span class="string">'list_id长度'</span> + str(len(list_id)))</span><br><span class="line"></span><br><span class="line">f_id_hash_final = open(<span class="string">"id_hash_final.txt"</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"final_hashs.txt"</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">dict_id_hash = &#123;&#125;</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line_txt = f.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_txt:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dict_id_hash[get_id(line_txt)[<span class="number">0</span>]] = get_text(line_txt)[<span class="number">0</span>]</span><br><span class="line">f.close()</span><br><span class="line">print(<span class="string">'dict_id_hash长度'</span> + str(len(dict_id_hash)))  <span class="comment"># 121117</span></span><br><span class="line">f_dict_id_hash = open(<span class="string">"dict_id_hash.txt"</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">f_dict_id_hash.write(str(dict_id_hash))</span><br><span class="line">f_dict_id_hash.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> id <span class="keyword">in</span> list_id:</span><br><span class="line">    id = id.replace(<span class="string">'.mp4'</span>, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    f_id_hash_final.write(id + <span class="string">'::::'</span> + dict_id_hash[id] + <span class="string">'\n'</span>)</span><br><span class="line">f_id_hash_final.close()</span><br><span class="line"></span><br><span class="line">f_id_hash_final = open(<span class="string">"id_hash_final.txt"</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">f_count_hash = open(<span class="string">"count_hash.txt"</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">subString1</span><span class="params">(template)</span>:</span>  <span class="comment"># HashTag以‘#’开头，以空格或回车结尾</span></span><br><span class="line">    copy = <span class="keyword">False</span></span><br><span class="line">    finished = <span class="keyword">False</span></span><br><span class="line">    slotList = []</span><br><span class="line">    str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> template:</span><br><span class="line">        <span class="keyword">if</span> s == <span class="string">'#'</span>:</span><br><span class="line">            copy = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> s == <span class="string">' '</span>:</span><br><span class="line">            copy = <span class="keyword">False</span></span><br><span class="line">            finished = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> s == <span class="string">'\n'</span>:</span><br><span class="line">            copy = <span class="keyword">False</span></span><br><span class="line">            finished = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> copy:</span><br><span class="line">            str = str + s</span><br><span class="line">        <span class="keyword">if</span> finished:</span><br><span class="line">            <span class="keyword">if</span> str != <span class="string">""</span>:</span><br><span class="line">                slotList.append(str)</span><br><span class="line">            str = <span class="string">""</span></span><br><span class="line">            finished = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">return</span> slotList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">slotList = []</span><br><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="comment"># for i in range(0,3):</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line_id_hash = f_id_hash_final.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_id_hash:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># print()</span></span><br><span class="line">        slotList += subString1(line_id_hash)  <span class="comment"># 将所有HashTag存进list</span></span><br><span class="line"><span class="comment"># print(slotList)</span></span><br><span class="line"></span><br><span class="line">result = collections.Counter(slotList)  <span class="comment"># 词频统计</span></span><br><span class="line"><span class="comment"># ss = str(result)    #词频统计结果转换成字符串并存文件</span></span><br><span class="line"><span class="comment"># f_handle_hash.write(ss)</span></span><br><span class="line"><span class="comment"># print(result.most_common(100)) 查看统计结果前100名</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> result.most_common():</span><br><span class="line">    ss = str(each)  <span class="comment"># 词频统计结果转换成字符串并存文件</span></span><br><span class="line">    f_count_hash.write(ss + <span class="string">'\n'</span>)</span><br><span class="line">    <span class="comment"># print(ss)</span></span><br><span class="line">f_id_hash_final.close()</span><br><span class="line">f_count_hash.close()</span><br></pre></td></tr></table></figure>
<h5 id="截取指定长度数据"><a href="#截取指定长度数据" class="headerlink" title="截取指定长度数据"></a>截取指定长度数据</h5><p>根据词频统计截取hash词频不小于5的数据存入id_hash</p>
<h6 id="count-num-hash-py"><a href="#count-num-hash-py" class="headerlink" title="count_num_hash.py"></a>count_num_hash.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getText</span><span class="params">(template)</span>:</span></span><br><span class="line">    rule = <span class="string">r'::::(.*?)\n'</span></span><br><span class="line">    slotList = re.findall(rule, template)</span><br><span class="line">    <span class="keyword">return</span> slotList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_list_or_dict</span><span class="params">(path)</span>:</span></span><br><span class="line">    f = open(path, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    a = f.read()</span><br><span class="line">    dict_or_list = eval(a)</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> dict_or_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f_count_hash = open(<span class="string">"count_hash.txt"</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line"><span class="comment"># f_list_count_hash = open("list_count_hash.txt",'w',encoding='utf8', errors='ignore')</span></span><br><span class="line">list_hash = []</span><br><span class="line">flag_hash_line = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line_hash = f_count_hash.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_hash:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rule1 = <span class="string">r"'(.*?)'"</span></span><br><span class="line">        rule2 = <span class="string">r'"(.*?)"'</span></span><br><span class="line">        rule3 = <span class="string">r' (.*?)\)'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            slotList = re.findall(rule1, line_hash)</span><br><span class="line">            hash_num = re.findall(rule3, line_hash)</span><br><span class="line">            <span class="keyword">if</span> int(hash_num[<span class="number">0</span>]) == <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                list_hash.append(str(slotList[<span class="number">0</span>]))</span><br><span class="line">                flag_hash_line += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            slotList = re.findall(rule2, line_hash)</span><br><span class="line">            list_hash.append(str(slotList[<span class="number">0</span>]))</span><br><span class="line">            flag_hash_line += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(flag_hash_line)</span><br><span class="line"></span><br><span class="line">list_id = get_list_or_dict(<span class="string">'list_id.txt'</span>)</span><br><span class="line">print(len(list_id))</span><br><span class="line">dict_id_hash = get_list_or_dict(<span class="string">'dict_id_hash.txt'</span>)</span><br><span class="line">print(len(dict_id_hash))</span><br><span class="line"></span><br><span class="line">f_id_hash = open(<span class="string">"id_hash"</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> id <span class="keyword">in</span> list_id:</span><br><span class="line">    id = str(id).replace(<span class="string">'.mp4'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="comment"># print(id)</span></span><br><span class="line">    line_list_hash = dict_id_hash[id].split(<span class="string">' '</span>)</span><br><span class="line">    <span class="comment"># print(line_list_hash)</span></span><br><span class="line">    line_hash_new = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> hash <span class="keyword">in</span> line_list_hash:</span><br><span class="line">        hash = str(hash).replace(<span class="string">'#'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> hash <span class="keyword">in</span> list_hash:</span><br><span class="line">            line_hash_new += <span class="string">'#'</span> + hash + <span class="string">' '</span></span><br><span class="line">    <span class="keyword">if</span> line_hash_new != <span class="string">''</span>:</span><br><span class="line">    <span class="comment">#     print('空：' + id)</span></span><br><span class="line">    <span class="comment"># else:</span></span><br><span class="line">        f_id_hash.write(id+<span class="string">'::::'</span>+line_hash_new+<span class="string">'\n'</span>)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">10000</span> == <span class="number">0</span>):</span><br><span class="line">        print(i)</span><br><span class="line">f_id_hash.close()</span><br><span class="line">print(i)</span><br></pre></td></tr></table></figure>
<p>最终处理获得118684长度的id_hash文件</p>
<h5 id="清理数据"><a href="#清理数据" class="headerlink" title="清理数据"></a>清理数据</h5><p>根据id_error文件从119120条分割后文件集中删除不合法数据</p>
<h6 id="clean-extract-data-py"><a href="#clean-extract-data-py" class="headerlink" title="clean_extract_data.py"></a>clean_extract_data.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_id</span><span class="params">(template)</span>:</span></span><br><span class="line">    rule = <span class="string">r'(.*?)::::'</span></span><br><span class="line">    slot_list = re.findall(rule, template)</span><br><span class="line">    <span class="keyword">return</span> slot_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_list_or_dict</span><span class="params">(path)</span>:</span></span><br><span class="line">    f = open(path, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    a = f.read()</span><br><span class="line">    dict_or_list = eval(a)</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> dict_or_list</span><br><span class="line"></span><br><span class="line">dict_id_num = get_list_or_dict(<span class="string">'dict_id_num.txt'</span>)</span><br><span class="line">print(len(dict_id_num))</span><br><span class="line"></span><br><span class="line">list_id_error = []</span><br><span class="line">f_id_error = open(<span class="string">'id_error'</span>, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line_id_error = f_id_error.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_id_error:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        list_id_error.append(dict_id_num[line_id_error.replace(<span class="string">'\n'</span>,<span class="string">''</span>)])</span><br><span class="line">print(len(list_id_error))</span><br><span class="line"></span><br><span class="line">path = <span class="string">'/home/caoda/Hodge_work_space/dataset/dataset'</span></span><br><span class="line">ii = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">16</span>):</span><br><span class="line">    list_extract_num = os.listdir(path + str(i))</span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> list_extract_num:</span><br><span class="line">        <span class="keyword">if</span>(num <span class="keyword">in</span> list_id_error):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                shutil.rmtree(path+str(i)+<span class="string">'/'</span>+num)</span><br><span class="line">                <span class="comment"># print(path+str(i)+'/'+num)</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                print(<span class="string">'删除出错'</span>)</span><br><span class="line">    ii += len(os.listdir(path + str(i)))</span><br><span class="line">print(ii)</span><br></pre></td></tr></table></figure>
<p>到目前为止数据集已准备并分割完毕。<br>数据集与代码，发布在<a href="https://github.com/Hodgeli/vine_dataset" title="vine数据集" target="_blank" rel="noopener">github</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/09/clean-down-data/" data-id="cl8vfrwqm000xogc543edvgs0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/字符串处理/">字符串处理</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-code-base" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/21/code-base/" class="article-date">
  <time datetime="2017-12-21T12:23:15.000Z" itemprop="datePublished">2017-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/函数库/">函数库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/21/code-base/">python函数库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h5><h6 id="截取字符串"><a href="#截取字符串" class="headerlink" title="截取字符串"></a>截取字符串</h6><p>截取指定两个符号间的字符串返回所有符合结果的list<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_list_hash</span><span class="params">(template)</span>:</span>  <span class="comment"># HashTag以‘#’开头，以空格或回车结尾</span></span><br><span class="line">    copy = <span class="keyword">False</span></span><br><span class="line">    finished = <span class="keyword">False</span></span><br><span class="line">    slotList = []</span><br><span class="line">    str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> template:</span><br><span class="line">        <span class="keyword">if</span> s == <span class="string">'#'</span>:</span><br><span class="line">            copy = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> s == <span class="string">' '</span>:</span><br><span class="line">            copy = <span class="keyword">False</span></span><br><span class="line">            finished = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> s == <span class="string">'\n'</span>:</span><br><span class="line">            copy = <span class="keyword">False</span></span><br><span class="line">            finished = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">elif</span> copy:</span><br><span class="line">            str = str + s</span><br><span class="line">        <span class="keyword">if</span> finished:</span><br><span class="line">            <span class="keyword">if</span> str != <span class="string">""</span>:</span><br><span class="line">                slotList.append(str)</span><br><span class="line">            str = <span class="string">""</span></span><br><span class="line">            finished = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">return</span> slotList</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_text</span><span class="params">(template)</span>:</span></span><br><span class="line">    rule = <span class="string">r':::(.*?)\n'</span></span><br><span class="line">    slot_list = re.findall(rule, template)</span><br><span class="line">    <span class="keyword">return</span> slot_list</span><br></pre></td></tr></table></figure>
<h6 id="判断是否为英文字母"><a href="#判断是否为英文字母" class="headerlink" title="判断是否为英文字母"></a>判断是否为英文字母</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解决.isalpha()方法对（unicode string，string.isalpha会根据字符串中的字符是否属于Unicode编码的LETTER区域来判断是否都由字母组成。</span></span><br><span class="line"><span class="comment"># 所以得出的结果为True，不一定表示只有26个英文字母。）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_alpha</span><span class="params">(word)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> word.encode(<span class="string">'ascii'</span>).isalpha()</span><br><span class="line">    <span class="keyword">except</span> UnicodeEncodeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h5 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h5><h6 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mkdir</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="comment"># 去除首位空格</span></span><br><span class="line">    path = path.strip()</span><br><span class="line">    <span class="comment"># 去除尾部 \ 符号</span></span><br><span class="line">    path = path.rstrip(<span class="string">"/"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断路径是否存在</span></span><br><span class="line">    <span class="comment"># 存在     True</span></span><br><span class="line">    <span class="comment"># 不存在   False</span></span><br><span class="line">    isExists = os.path.exists(path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断结果</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isExists:</span><br><span class="line">        <span class="comment"># 如果不存在则创建目录</span></span><br><span class="line">        <span class="comment"># 创建目录操作函数</span></span><br><span class="line">        os.makedirs(path)</span><br><span class="line"></span><br><span class="line">        print(str(path) + <span class="string">' 创建成功'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果目录存在则不创建，并提示目录已存在</span></span><br><span class="line">        print(str(path) + <span class="string">' 目录已存在'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h6 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h6><p>读取并按行遍历文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">f_video_text = open(<span class="string">"video_text.txt"</span>,<span class="attribute">encoding</span>=<span class="string">'utf8'</span>, <span class="attribute">errors</span>=<span class="string">'ignore'</span>)</span><br><span class="line"><span class="keyword">while</span> 1:</span><br><span class="line">    line_video_text = f_video_text.readline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line_video_text:</span><br><span class="line">        break</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">do</span> something</span><br></pre></td></tr></table></figure></p>
<h6 id="读取文件夹下所有文件名，返回list"><a href="#读取文件夹下所有文件名，返回list" class="headerlink" title="读取文件夹下所有文件名，返回list"></a>读取文件夹下所有文件名，返回list</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_list_file_name</span><span class="params">(file_dir)</span>:</span>  <span class="comment"># 获取视频名list</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(file_dir):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> files</span><br></pre></td></tr></table></figure>
<h6 id="获取文件行数"><a href="#获取文件行数" class="headerlink" title="获取文件行数"></a>获取文件行数</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def get_lines(file_name):</span><br><span class="line">    <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    thefile = <span class="keyword">open</span>(file_name, encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        <span class="keyword">buffer</span> = thefile.<span class="keyword">read</span>(<span class="number">1024</span> * <span class="number">8192</span>)</span><br><span class="line">        <span class="keyword">if</span> not <span class="keyword">buffer</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">count</span> += <span class="keyword">buffer</span>.<span class="built_in">count</span>(<span class="string">'\n'</span>)</span><br><span class="line">    thefile.<span class="keyword">close</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">count</span></span><br></pre></td></tr></table></figure>
<h6 id="读取文件dict-or-list"><a href="#读取文件dict-or-list" class="headerlink" title="读取文件dict or list"></a>读取文件dict or list</h6><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def get_list_or_dict(path):</span><br><span class="line">    f = <span class="built_in">open</span>(path,encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    <span class="keyword">a</span> = f.<span class="built_in">read</span>()</span><br><span class="line">    dict_or_list = eval(<span class="keyword">a</span>)</span><br><span class="line">    f.<span class="built_in">close</span>()</span><br><span class="line">    <span class="literal">return</span> dict_or_list</span><br></pre></td></tr></table></figure>
<h6 id="txt文件数据写成dict-or-list文件"><a href="#txt文件数据写成dict-or-list文件" class="headerlink" title="txt文件数据写成dict or list文件"></a>txt文件数据写成dict or list文件</h6><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def write_list_or_dict(path_txt,path_dict_or_list_txt):</span><br><span class="line">    f = <span class="built_in">open</span>(path_txt,encoding=<span class="string">'utf8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    <span class="built_in">while</span> <span class="number">1</span>:</span><br><span class="line">        line_txt = f.readline()</span><br><span class="line">        <span class="built_in">if</span> <span class="keyword">not</span> line_txt:</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        <span class="built_in">else</span>:</span><br><span class="line">            handle</span><br><span class="line">            list_or_dict[id] = content</span><br><span class="line">    f.<span class="built_in">close</span>()</span><br><span class="line">    f = <span class="built_in">open</span>(path_dict_or_list_txt, <span class="string">'w'</span> , encoding=<span class="string">'utf8'</span> , errors=<span class="string">'ignore'</span>)</span><br><span class="line">    f.<span class="built_in">write</span>(str(list_or_dict))</span><br><span class="line">    f.<span class="built_in">close</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'写入成功'</span>)</span><br></pre></td></tr></table></figure>
<h6 id="获取视频或音频时长"><a href="#获取视频或音频时长" class="headerlink" title="获取视频或音频时长"></a>获取视频或音频时长</h6><p>获取视频或音频时长，需要安装ffmpeg<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def get_time(filename):</span><br><span class="line">    <span class="keyword">command</span> = <span class="string">'ffprobe -loglevel quiet -print_format json -show_format -show_streams -i '</span> + <span class="title">filename</span></span><br><span class="line">    <span class="built_in">result</span> = subprocess.Popen(<span class="keyword">command</span>, <span class="title">shell</span>=<span class="title">True</span>, <span class="title">stdout</span>=<span class="title">subprocess</span>.<span class="title">PIPE</span>, <span class="title">stderr</span>=<span class="title">subprocess</span>.<span class="title">STDOUT</span>)</span><br><span class="line">    out = <span class="built_in">result</span>.<span class="keyword">stdout</span>.<span class="built_in">read</span>()</span><br><span class="line"></span><br><span class="line">    temp = str(out.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    data = json.loads(temp)[<span class="string">"format"</span>][<span class="string">'duration'</span>]</span><br><span class="line">    <span class="literal">return</span> data</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/21/code-base/" data-id="cl8vfrwqm000uogc5i8hyeb8k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/函数/">函数</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/30-N天自制操作系统/">30*N天自制操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CS231n/">CS231n</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PyTorch笔记/">PyTorch笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python踩坑指南/">Python踩坑指南</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Raspberry-Pi/">Raspberry Pi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/caffe/">caffe</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/raspbian/">raspbian</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/函数库/">函数库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/参考手册/">参考手册</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习方法/">学习方法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具积累/">工具积累</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/整理/">整理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/爬虫/">爬虫</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/目标检测/">目标检测</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/神经网络/">神经网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读论文/">读论文</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/API/">API</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AlexNet/">AlexNet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Array/">Array</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Attention-Network/">Attention Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOs/">CentOs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP基础/">HTTP基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MLP/">MLP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raspberry-Pi/">Raspberry Pi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/">String</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/caffe/">caffe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy/">deploy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg/">ffmpeg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lda/">lda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/object-detect/">object_detect</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/">os</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pytorch/">pytorch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspbian/">raspbian</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrapy/">scrapy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/">sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tornado/">tornado</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/twitter/">twitter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/union-find/">union-find</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/下载/">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代理的基本原理/">代理的基本原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/会话与Cookies/">会话与Cookies</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数/">函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/包使用/">包使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/双系统/">双系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/字符串处理/">字符串处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/快捷键/">快捷键</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/整理/">整理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件读取/">文件读取</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编/">汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫原理/">爬虫原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫基础库/">爬虫基础库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫实践/">爬虫实践</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫解析库/">爬虫解析库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/神经网络/">神经网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔记/">笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网页基础/">网页基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/视频处理/">视频处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读论文/">读论文</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/阅读/">阅读</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AlexNet/" style="font-size: 10px;">AlexNet</a> <a href="/tags/Array/" style="font-size: 12.5px;">Array</a> <a href="/tags/Attention-Network/" style="font-size: 10px;">Attention Network</a> <a href="/tags/CentOs/" style="font-size: 10px;">CentOs</a> <a href="/tags/HTTP基础/" style="font-size: 10px;">HTTP基础</a> <a href="/tags/LeetCode/" style="font-size: 17.5px;">LeetCode</a> <a href="/tags/MLP/" style="font-size: 10px;">MLP</a> <a href="/tags/Raspberry-Pi/" style="font-size: 10px;">Raspberry Pi</a> <a href="/tags/String/" style="font-size: 10px;">String</a> <a href="/tags/caffe/" style="font-size: 12.5px;">caffe</a> <a href="/tags/deploy/" style="font-size: 10px;">deploy</a> <a href="/tags/ffmpeg/" style="font-size: 10px;">ffmpeg</a> <a href="/tags/git/" style="font-size: 12.5px;">git</a> <a href="/tags/lda/" style="font-size: 10px;">lda</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/object-detect/" style="font-size: 10px;">object_detect</a> <a href="/tags/os/" style="font-size: 10px;">os</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/pytorch/" style="font-size: 20px;">pytorch</a> <a href="/tags/raspbian/" style="font-size: 12.5px;">raspbian</a> <a href="/tags/scrapy/" style="font-size: 10px;">scrapy</a> <a href="/tags/sort/" style="font-size: 12.5px;">sort</a> <a href="/tags/tornado/" style="font-size: 10px;">tornado</a> <a href="/tags/twitter/" style="font-size: 10px;">twitter</a> <a href="/tags/union-find/" style="font-size: 10px;">union-find</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/代理的基本原理/" style="font-size: 10px;">代理的基本原理</a> <a href="/tags/会话与Cookies/" style="font-size: 10px;">会话与Cookies</a> <a href="/tags/函数/" style="font-size: 12.5px;">函数</a> <a href="/tags/包使用/" style="font-size: 10px;">包使用</a> <a href="/tags/双系统/" style="font-size: 10px;">双系统</a> <a href="/tags/字符串处理/" style="font-size: 15px;">字符串处理</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/快捷键/" style="font-size: 10px;">快捷键</a> <a href="/tags/整理/" style="font-size: 10px;">整理</a> <a href="/tags/文件读取/" style="font-size: 15px;">文件读取</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/爬虫/" style="font-size: 15px;">爬虫</a> <a href="/tags/爬虫原理/" style="font-size: 10px;">爬虫原理</a> <a href="/tags/爬虫基础库/" style="font-size: 10px;">爬虫基础库</a> <a href="/tags/爬虫实践/" style="font-size: 10px;">爬虫实践</a> <a href="/tags/爬虫解析库/" style="font-size: 10px;">爬虫解析库</a> <a href="/tags/神经网络/" style="font-size: 20px;">神经网络</a> <a href="/tags/笔记/" style="font-size: 12.5px;">笔记</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/网页基础/" style="font-size: 10px;">网页基础</a> <a href="/tags/视频处理/" style="font-size: 10px;">视频处理</a> <a href="/tags/读论文/" style="font-size: 10px;">读论文</a> <a href="/tags/阅读/" style="font-size: 10px;">阅读</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/05/test-new-begin/">test_new_begin</a>
          </li>
        
          <li>
            <a href="/2020/03/14/LeetCode-String/">LeetCode_String</a>
          </li>
        
          <li>
            <a href="/2020/03/09/read/">read</a>
          </li>
        
          <li>
            <a href="/2020/03/08/sort-out/">sort_out</a>
          </li>
        
          <li>
            <a href="/2020/02/19/CVTEpro/">CVTEpro</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Hodge Li<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>